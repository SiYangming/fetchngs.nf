/*
========================================================================================
    nf-core/fetchngs 自定义配置模板
========================================================================================
    作用：覆盖流程的默认设置，自定义资源分配、工具参数和执行行为
    使用方法：
        nextflow run nf-core/fetchngs \\
            --input ids.csv \\
            --outdir results \\
            -profile docker \\
            -c fetchngs_custom_config.config
========================================================================================
*/

// ============================================================================
// 1. 流程参数配置（可直接在此设置，也可通过命令行 --参数名 传递）
// ============================================================================
params {
    // 输入输出
    // input                       = 'samplesheet.csv'  // 输入文件路径
    // outdir                      = './results'         // 输出目录
    
    // 下载方法选择
    download_method             = 'ftp'              // 可选: 'ftp', 'aspera', 'sratools'
    skip_fastq_download         = false              // 设置为 true 则仅下载元数据
    
    // ENA 元数据配置
    // ena_metadata_fields       = null                // 自定义元数据字段，逗号分隔
    sample_mapping_fields       = 'experiment_accession,run_accession,sample_accession,experiment_alias,run_alias,sample_alias,experiment_title,sample_title,sample_description'
    
    // nf-core 流程集成
    // nf_core_pipeline          = 'rnaseq'            // 可选: 'rnaseq', 'atacseq', 'viralrecon', 'taxprofiler'
    nf_core_rnaseq_strandedness = 'auto'             // RNA-seq 链特异性: 'auto', 'forward', 'reverse', 'unstranded'
    
    // dbGaP 受保护数据访问
    // dbgap_key                 = '/path/to/cart.jwt' // dbGaP JWT 密钥文件
    
    // 通知配置
    // email                     = 'your.email@example.com'
    // email_on_fail             = 'admin@example.com'
    plaintext_email             = false              // 使用纯文本邮件而非 HTML
    
    // 发布配置
    publish_dir_mode            = 'copy'             // 可选: 'symlink', 'rellink', 'link', 'copy', 'copyNoFollow', 'move'
    
    // 资源上限（防止单个任务占用过多资源）
    max_cpus                    = 16
    max_memory                  = '128.GB'
    max_time                    = '240.h'
}

// ============================================================================
// 2. 进程级别的资源和参数配置
// ============================================================================
process {
    
    // --------------------------------------------------------------------
    // 2.1 全局默认资源配置
    // --------------------------------------------------------------------
    cpus   = 2
    memory = '12.GB'
    time   = '4.h'
    
    // 错误处理策略
    errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }
    maxRetries    = 1
    maxErrors     = '-1'
    
    // --------------------------------------------------------------------
    // 2.2 按标签分配资源（适用于所有带该标签的进程）
    // --------------------------------------------------------------------
    
    withLabel: process_single {
        cpus   = 1
        memory = '6.GB'
        time   = '4.h'
    }
    
    withLabel: process_low {
        cpus   = 2
        memory = '12.GB'
        time   = '4.h'
    }
    
    withLabel: process_medium {
        cpus   = 6
        memory = '36.GB'
        time   = '8.h'
    }
    
    withLabel: process_high {
        cpus   = 12
        memory = '72.GB'
        time   = '16.h'
    }
    
    withLabel: process_long {
        time   = '20.h'
    }
    
    withLabel: process_high_memory {
        memory = '200.GB'
    }
    
    withLabel: error_retry {
        errorStrategy = 'retry'
        maxRetries    = 2
    }
    
    // --------------------------------------------------------------------
    // 2.3 特定进程的自定义配置
    // --------------------------------------------------------------------
    
    // SRA ID 到 RunInfo 转换
    withName: 'SRA_IDS_TO_RUNINFO' {
        cpus   = 2
        memory = '12.GB'
        time   = '2.h'
        // ext.args = ''  // 传递给 Python 脚本的额外参数
    }
    
    // RunInfo 到 FTP 链接转换
    withName: 'SRA_RUNINFO_TO_FTP' {
        cpus   = 1
        memory = '6.GB'
        time   = '1.h'
    }
    
    // FTP 下载（使用 wget）
    withName: 'SRA_FASTQ_FTP' {
        cpus   = 2
        memory = '12.GB'
        time   = '8.h'
        maxRetries = 3  // 下载失败多重试几次
        
        // wget 参数配置（关键配置！）
        ext.args = [
            '-t 10',      // 重试次数：10 次（适合网络不稳定）
            '-nv',        // 非详细模式：减少输出
            '-c',         // 断点续传：从断点处继续
            '-T 300',     // 超时时间：300 秒（适合大文件）
            '--retry-connrefused',  // 连接被拒绝时重试
            '--waitretry=10'        // 重试间隔：10 秒
        ].join(' ')
        
        // 自定义发布目录
        publishDir = [
            [
                path: { "${params.outdir}/fastq" },
                mode: params.publish_dir_mode,
                pattern: "*.fastq.gz",
                saveAs: { filename -> filename }
            ],
            [
                path: { "${params.outdir}/fastq/md5" },
                mode: params.publish_dir_mode,
                pattern: "*.md5"
            ]
        ]
    }
    
    // Aspera 下载（使用 Aspera CLI）
    withName: 'ASPERA_CLI' {
        cpus   = 4
        memory = '16.GB'
        time   = '8.h'
        maxRetries = 3
        
        // Aspera 参数
        ext.args = [
            '-l 300M',    // 限速：300 MB/s
            '-P 33001',   // 端口
            '-k 1'        // 断点续传
        ].join(' ')
    }
    
    // SRA-tools prefetch
    withName: 'SRATOOLS_PREFETCH' {
        cpus   = 2
        memory = '16.GB'
        time   = '8.h'
        maxRetries = 3
        
        ext.args = '--max-size 100G'  // 最大文件大小限制
    }
    
    // SRA-tools fasterq-dump
    withName: 'SRATOOLS_FASTERQDUMP' {
        cpus   = 6
        memory = '36.GB'
        time   = '12.h'
        
        ext.args = [
            '--split-files',      // 拆分 PE 数据
            '--include-technical' // 包含技术序列
        ].join(' ')
    }
    
    // 生成 samplesheet
    withName: 'SRA_TO_SAMPLESHEET' {
        cpus   = 1
        memory = '6.GB'
        time   = '1.h'
        
        publishDir = [
            path: { "${params.outdir}/samplesheet" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename }
        ]
    }
    
    // MultiQC 映射配置
    withName: 'MULTIQC_MAPPINGS_CONFIG' {
        cpus   = 1
        memory = '6.GB'
        time   = '1.h'
    }
}

// ============================================================================
// 3. 执行器配置（根据运行环境选择）
// ============================================================================

// executor {
//     // 本地执行器配置
//     name = 'local'
//     cpus = 16
//     memory = '64.GB'
//     
//     // 或者使用集群执行器
//     // name = 'slurm'
//     // queueSize = 50
//     // submitRateLimit = '10 sec'
//     // 
//     // // PBS/Torque
//     // name = 'pbs'
//     // queueSize = 100
//     // 
//     // // AWS Batch
//     // name = 'awsbatch'
//     // queueSize = 1000
// }

// ============================================================================
// 4. 容器/环境配置
// ============================================================================

// Docker 配置
docker {
    enabled = false  // 如果使用 -profile docker 则无需在此启用
    // runOptions = '-u $(id -u):$(id -g)'
    // registry = 'quay.io'
    // temp = 'auto'
}

// Singularity 配置
singularity {
    enabled = false  // 如果使用 -profile singularity 则无需在此启用
    // autoMounts = true
    // cacheDir = '/path/to/singularity/cache'
    // runOptions = '--bind /data:/data'
}

// Conda 配置
conda {
    enabled = false  // 如果使用 -profile conda 则无需在此启用
    // cacheDir = '/path/to/conda/cache'
    // createTimeout = '1 h'
}

// ============================================================================
// 5. 报告和追踪配置
// ============================================================================

def trace_timestamp = new java.util.Date().format('yyyy-MM-dd_HH-mm-ss')

timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_timeline_${trace_timestamp}.html"
    overwrite = true
}

report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_report_${trace_timestamp}.html"
    overwrite = true
}

trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_trace_${trace_timestamp}.txt"
    fields  = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes,vol_ctxt,inv_ctxt,workdir,scratch,error_action'
    overwrite = true
}

dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/pipeline_dag_${trace_timestamp}.html"
    overwrite = true
}

// ============================================================================
// 6. 环境变量配置
// ============================================================================

env {
    // Python
    PYTHONNOUSERSITE = 1
    // PYTHONPATH = '/custom/python/path'
    
    // R
    R_PROFILE_USER   = "/.Rprofile"
    R_ENVIRON_USER   = "/.Renviron"
    
    // 代理设置（如果需要）
    // HTTP_PROXY  = 'http://proxy.example.com:8080'
    // HTTPS_PROXY = 'http://proxy.example.com:8080'
    // NO_PROXY    = 'localhost,127.0.0.1'
    
    // SRA-tools 配置
    // NCBI_SETTINGS = '/path/to/ncbi/settings'
}

// ============================================================================
// 7. 工作目录和临时文件配置
// ============================================================================

workDir = './work'  // Nextflow 工作目录

// 清理选项
cleanup = false  // 设置为 true 自动清理成功的工作文件

// ============================================================================
// 8. 高级配置
// ============================================================================

// 管道执行配置
manifest {
    // 这些通常不需要修改，除非你 fork 了流程
    // name            = 'nf-core/fetchngs'
    // nextflowVersion = '!>=23.04.0'
}

// Nextflow 功能开关
nextflow {
    enable {
        dsl = 2
        // configProcessNamesValidation = true
    }
}

// 作用域配置
scope {
    // 工作流作用域
    // workflow.onComplete 在此配置
}

// ============================================================================
// 9. 性能优化选项
// ============================================================================

// 并行下载数量限制（通过信号量控制）
// process {
//     withName: 'SRA_FASTQ_FTP|ASPERA_CLI|SRATOOLS_FASTERQDUMP' {
//         maxForks = 5  // 同时最多 5 个下载任务
//     }
// }

// 缓存策略
// cache = 'lenient'  // 可选: 'strict', 'lenient', 'deep'

// ============================================================================
// 10. 云平台特定配置（AWS/Azure/GCP）
// ============================================================================

// AWS 配置示例
// aws {
//     region = 'us-east-1'
//     batch {
//         cliPath = '/home/ec2-user/miniconda/bin/aws'
//         jobRole = 'arn:aws:iam::YOUR_ACCOUNT:role/BatchJobRole'
//         volumes = '/docker_scratch:/tmp:rw'
//     }
// }

// Azure 配置示例
// azure {
//     storage {
//         accountName = 'mystorageaccount'
//         accountKey = 'xxx'
//     }
//     batch {
//         location = 'eastus'
//         accountName = 'mybatchaccount'
//     }
// }

// Google Cloud 配置示例
// google {
//     project = 'my-project-id'
//     region  = 'us-central1'
//     lifeSciences {
//         bootDiskSize = '50.GB'
//     }
// }

/*
========================================================================================
    使用示例
========================================================================================

1. 基本使用（FTP 下载）：
   nextflow run nf-core/fetchngs \\
       --input sra_ids.txt \\
       --outdir results \\
       -profile docker \\
       -c custom.config

2. 使用 Aspera 高速下载：
   nextflow run nf-core/fetchngs \\
       --input sra_ids.txt \\
       --outdir results \\
       --download_method aspera \\
       -profile docker \\
       -c custom.config

3. 仅下载元数据：
   nextflow run nf-core/fetchngs \\
       --input sra_ids.txt \\
       --outdir results \\
       --skip_fastq_download \\
       -profile docker \\
       -c custom.config

4. 为 nf-core/rnaseq 准备 samplesheet：
   nextflow run nf-core/fetchngs \\
       --input sra_ids.txt \\
       --outdir results \\
       --nf_core_pipeline rnaseq \\
       --nf_core_rnaseq_strandedness auto \\
       -profile docker \\
       -c custom.config

5. 使用 dbGaP 受保护数据：
   nextflow run nf-core/fetchngs \\
       --input dbgap_ids.txt \\
       --outdir results \\
       --download_method sratools \\
       --dbgap_key cart.jwt \\
       -profile docker \\
       -c custom.config

========================================================================================
    配置优先级
========================================================================================
1. 命令行参数（--参数名）         > 
2. -params-file 指定的参数文件    >
3. -c 指定的配置文件（本文件）    >
4. 流程默认配置                  

注意：-c 配置文件主要用于进程资源、工具参数等，流程参数建议用 --参数名 传递
========================================================================================
*/
