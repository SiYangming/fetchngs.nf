/*
========================================================================================
    nf-core/fetchngs Unified Configuration File
========================================================================================
    Available Scenarios (Uncomment the corresponding block to enable):
    1. Network Unstable (Scenario 1) - For poor internet connections
    2. High Performance (Scenario 2) - For HPC/Clusters with Aspera
    3. Limited Resources (Scenario 3) - For laptops/personal computers
    4. Metadata Only (Scenario 4) - Download metadata without FASTQ
    5. RNA-seq Integration (Scenario 5) - Generate samplesheet for nf-core/rnaseq
    6. Cloud/AWS (Scenario 6) - For AWS Batch execution
========================================================================================
*/

params {
    // =================================================================================
    // Global Options
    // =================================================================================
    config_profile_name        = 'Unified Profile'
    config_profile_description = 'Unified configuration for various environments'

    // Base defaults
    max_cpus   = 16
    max_memory = '128.GB'
    max_time   = '240.h'

    // =================================================================================
    // Scenario Selection
    // =================================================================================

    // --- Scenario 2: High Performance (HPC/Aspera) ---
    // download_method = 'aspera'
    // max_cpus = 32
    // max_memory = '256.GB'

    // --- Scenario 3: Limited Resources (Laptop) ---
    // download_method = 'ftp'
    // max_cpus = 4
    // max_memory = '16.GB'
    // max_time = '72.h'

    // --- Scenario 4: Metadata Only ---
    // skip_fastq_download = true

    // --- Scenario 5: RNA-seq Integration ---
    // nf_core_pipeline = 'rnaseq'
    // nf_core_rnaseq_strandedness = 'auto'
    // sample_mapping_fields = 'experiment_accession,run_accession,sample_accession,experiment_alias,run_alias,sample_alias,experiment_title,sample_title,sample_description,library_layout,library_strategy,library_source,library_selection,instrument_platform,instrument_model'

    // --- Default Fallbacks ---
    download_method = 'ftp'
    skip_fastq_download = false
    nf_core_pipeline = null
}

// =================================================================================
// Process Configuration
// =================================================================================

process {
    
    // Global Resource Limits (Default)
    cpus   = { check_max( 1    * task.attempt, 'cpus'   ) }
    memory = { check_max( 6.GB * task.attempt, 'memory' ) }
    time   = { check_max( 4.h  * task.attempt, 'time'   ) }

    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 1
    maxErrors     = '-1'

    // =================================================================================
    // Scenario 1: Network Unstable Configuration
    // =================================================================================
    // Uncomment the following block for unstable networks:
    /*
    withName: 'SRA_FASTQ_FTP|ASPERA_CLI|SRA_IDS_TO_RUNINFO|SRA_RUNINFO_TO_FTP' {
        maxRetries = 5
        errorStrategy = 'retry'
    }
    withName: 'SRA_FASTQ_FTP' {
        // Robust wget args: 30 retries, 15 min timeout, wait 60s between retries
        ext.args = '-t 30 -nv -c -T 900 --waitretry=60 --retry-connrefused --read-timeout=600 --dns-timeout=120'
        time = { check_max(24.h * task.attempt, 'time') }
    }
    withName: 'SRA_IDS_TO_RUNINFO' {
         // Increase timeout for ID resolution
         time = '24.h'
    }
    */

    // =================================================================================
    // Scenario 2: High Performance Configuration (Aspera)
    // =================================================================================
    // Uncomment the following block for HPC/Aspera:
    /*
    withName: 'ASPERA_CLI' {
        cpus = 8
        memory = { check_max(32.GB * task.attempt, 'memory') }
        // Aspera args: 1000M limit, resume enabled
        ext.args = '-l 1000M -k 1 -P 33001 -m 100M'
    }
    withName: 'SRATOOLS_FASTERQDUMP' {
        cpus = 16
        memory = { check_max(64.GB * task.attempt, 'memory') }
        ext.args = '--split-files --threads 16 --mem 64GB --progress'
    }
    withName: 'SRA_FASTQ_FTP|ASPERA_CLI|SRATOOLS_FASTERQDUMP' {
        maxForks = 10
    }
    */

    // =================================================================================
    // Scenario 3: Limited Resources Configuration
    // =================================================================================
    // Uncomment the following block for limited resources:
    /*
    withName: 'SRA_FASTQ_FTP' {
        cpus = 1
        memory = '4.GB'
        time = '12.h'
        maxRetries = 3
        // Limited rate to 5MB/s to avoid network saturation
        ext.args = '-t 10 -nv -c -T 300 --limit-rate=5M'
    }
    withName: 'SRATOOLS_FASTERQDUMP' {
        cpus = 2
        memory = '8.GB'
        time = '12.h'
        ext.args = '--split-files --threads 2'
    }
    withName: 'SRA_FASTQ_FTP|ASPERA_CLI|SRATOOLS_FASTERQDUMP' {
        maxForks = 1 // Serial execution
    }
    */
    
    // Default SRA_FASTQ_FTP (if not overridden by scenarios)
    withName: 'SRA_FASTQ_FTP' {
        // Standard stable network settings
        // ext.args = '-t 5 -nv -c -T 60' 
    }
}

// =================================================================================
// Scenario 6: Cloud / AWS Batch
// =================================================================================
// Uncomment for AWS Batch execution
/*
aws {
    region = 'us-east-1'
    batch {
        cliPath = '/home/ec2-user/miniconda/bin/aws'
    }
}
process {
    executor = 'awsbatch'
    queue = 'my-batch-queue'
}
*/

// =================================================================================
// Helper Function: check_max
// =================================================================================
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max memory '${params.max_memory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max time '${params.max_time}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "   ### ERROR ###   Max cpus '${params.max_cpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}
